{% extends 'base.html' %}
{% block title %}User Management - RoomBook{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-2"><i class="bi bi-people-fill me-3"></i>User Management</h1>
            <p class="text-muted mb-0">Manage registered users and their data</p>
        </div>
        <button class="btn btn-outline-secondary" onclick="loadUsers()">
            <i class="bi bi-arrow-clockwise me-2"></i>Refresh
        </button>
    </div>

    <div class="card border-0 shadow-lg">
        <div class="card-body p-4">
            <div class="table-responsive">
                <table class="table table-hover" id="users-table">
                    <thead class="table-dark">
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Role</th>
                            <th>Rooms</th>
                            <th>Bookings</th>
                            <th>Joined</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody">
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading users...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Delete User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Are you sure you want to delete this user?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Warning:</strong> This will permanently delete the user and ALL associated data including:
                    <ul class="mb-0 mt-2">
                        <li>User profile and settings</li>
                        <li>All rooms posted by this user</li>
                        <li>All bookings made by this user</li>
                        <li>All invoices and payments</li>
                        <li>All notifications</li>
                    </ul>
                </div>
                <div class="user-info mt-3">
                    <strong>User:</strong> <span id="delete-username"></span><br>
                    <strong>Email:</strong> <span id="delete-email"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">
                    <i class="bi bi-trash me-2"></i>Delete User
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let users = [];
let userToDelete = null;

async function loadUsers() {
    try {
        const res = await fetch('/api/admin/users/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        console.log('Response status:', res.status);
        console.log('Response ok:', res.ok);
        
        if (!res.ok) {
            if (res.status === 403) {
                showToast('Access denied. Superuser access required.', 'error');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                return;
            }
            const errorData = await res.json();
            throw new Error(errorData.error || 'Failed to load users');
        }
        
        users = await res.json();
        console.log('Loaded users:', users);
        renderUsers();
    } catch (e) {
        console.error('Error loading users:', e);
        document.getElementById('users-tbody').innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-5">
                    <i class="bi bi-exclamation-triangle display-1 text-danger mb-3"></i>
                    <h5 class="text-danger">Error loading users</h5>
                    <p class="text-muted">${e.message}</p>
                    <button class="btn btn-primary" onclick="loadUsers()">Retry</button>
                </td>
            </tr>
        `;
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function renderUsers() {
    const tbody = document.getElementById('users-tbody');
    
    if (users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-5">
                    <i class="bi bi-people display-1 text-muted mb-3"></i>
                    <h5 class="text-muted">No users found</h5>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = users.map(user => `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <div class="avatar-circle me-2">
                        ${user.first_name ? user.first_name[0].toUpperCase() : user.username[0].toUpperCase()}
                    </div>
                    <div>
                        <strong>${user.first_name || user.username}</strong>
                        ${user.last_name ? user.last_name : ''}
                        <br>
                        <small class="text-muted">@${user.username}</small>
                    </div>
                </div>
            </td>
            <td>
                <a href="mailto:${user.email}" class="text-decoration-none">
                    ${user.email}
                </a>
            </td>
            <td>
                <span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">
                    ${user.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <span class="badge ${user.is_superuser ? 'bg-danger' : user.is_staff ? 'bg-warning' : 'bg-primary'}">
                    ${user.is_superuser ? 'Superuser' : user.is_staff ? 'Staff' : 'User'}
                </span>
            </td>
            <td>
                <span class="badge bg-info">${user.room_count}</span>
            </td>
            <td>
                <span class="badge bg-info">${user.booking_count}</span>
            </td>
            <td>
                <small>${user.date_joined}</small>
            </td>
            <td>
                <small>${user.last_login}</small>
            </td>
            <td>
                ${!user.is_superuser ? `
                    <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(${user.id}, '${user.username}', '${user.email}')">
                        <i class="bi bi-trash"></i>
                    </button>
                ` : `
                    <span class="text-muted">Protected</span>
                `}
            </td>
        </tr>
    `).join('');
}

function confirmDelete(userId, username, email) {
    userToDelete = userId;
    document.getElementById('delete-username').textContent = username;
    document.getElementById('delete-email').textContent = email;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

async function deleteUser() {
    if (!userToDelete) return;
    
    const confirmBtn = document.getElementById('confirm-delete-btn');
    const originalContent = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
    confirmBtn.disabled = true;
    
    try {
        const res = await fetch(`/api/admin/users/${userToDelete}/delete/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await res.json();
        
        if (!res.ok) {
            throw new Error(data.error || 'Failed to delete user');
        }
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
        
        // Show success message
        showToast(data.message, 'success');
        
        // Reload users
        loadUsers();
        
    } catch (e) {
        console.error(e);
        showToast(e.message || 'Failed to delete user', 'error');
    } finally {
        confirmBtn.innerHTML = originalContent;
        confirmBtn.disabled = false;
        userToDelete = null;
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    
    document.getElementById('confirm-delete-btn')?.addEventListener('click', deleteUser);
});

// Add some CSS for avatar circles
const style = document.createElement('style');
style.textContent = `
    .avatar-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #007bff, #6c757d);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
