{% extends 'base.html' %}
{% block title %}Received Booking Requests - RoomBook{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="mb-4"><i class="bi bi-inbox-fill"></i> Received Booking Requests</h1>
    <div id="bookings-container">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadBookings() {
    try {
        const res = await fetch('/api/bookings/received/');
        if (!res.ok) {
            if (res.status === 401) {
                window.location.href = '/login/';
                return;
            }
            throw new Error('Failed to load bookings');
        }
        
        const bookings = await res.json();
        const container = document.getElementById('bookings-container');
        
        if (bookings.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <p class="text-muted mt-3">No booking requests yet</p>
                    <p class="text-muted">When users book your rooms, requests will appear here</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>User</th>
                            <th>Room</th>
                            <th>Start Date</th>
                            <th>Months</th>
                            <th>Total Rent</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bookings.map(b => `
                            <tr>
                                <td>${b.user_name}</td>
                                <td>${b.room_title}</td>
                                <td>${b.start_date}</td>
                                <td>${b.months}</td>
                                <td>$${parseFloat(b.total_rent).toFixed(2)}</td>
                                <td><span class="badge badge-${b.status}">${b.status.charAt(0).toUpperCase() + b.status.slice(1)}</span></td>
                                <td>
                                    ${b.status === 'pending' ? `
                                        <button class="btn btn-success btn-sm" onclick="updateStatus(${b.id}, 'approve')">
                                            <i class="bi bi-check-lg"></i> Approve
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="updateStatus(${b.id}, 'reject')">
                                            <i class="bi bi-x-lg"></i> Reject
                                        </button>
                                    ` : '-'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (e) {
        console.error(e);
        document.getElementById('bookings-container').innerHTML = '<div class="alert alert-danger">Error loading bookings</div>';
    }
}

async function updateStatus(bookingId, action) {
    try {
        const res = await fetch(`/api/bookings/${action}/${bookingId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (!res.ok) throw new Error('Action failed');
        
        loadBookings();
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

loadBookings();
</script>
{% endblock %}
