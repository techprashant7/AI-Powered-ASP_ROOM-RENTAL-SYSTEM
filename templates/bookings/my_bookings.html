{% extends 'base.html' %}
{% block title %}My Bookings - RoomBook{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="mb-4"><i class="bi bi-calendar-check"></i> My Bookings</h1>
    <div id="bookings-container">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadBookings() {
    try {
        const res = await fetch('/api/bookings/my/');
        if (!res.ok) {
            if (res.status === 401) {
                window.location.href = '/login/';
                return;
            }
            throw new Error('Failed to load bookings');
        }
        
        const bookings = await res.json();
        const container = document.getElementById('bookings-container');
        
        if (bookings.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <p class="text-muted mt-3">No bookings yet</p>
                    <a href="/rooms/" class="btn btn-primary">Browse Rooms</a>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Room</th>
                            <th>Location</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Months</th>
                            <th>Total Rent</th>
                            <th>Status</th>
                            <th>Invoice</th>
                            <th>Payment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bookings.map(b => `
                            <tr>
                                <td><a href="/rooms/${b.room}/">${b.room_title}</a></td>
                                <td>${b.room_location}</td>
                                <td>${b.start_date}</td>
                                <td>${b.end_date}</td>
                                <td>${b.months}</td>
                                <td>$${parseFloat(b.total_rent).toFixed(2)}</td>
                                <td><span class="badge badge-${b.status}">${b.status.charAt(0).toUpperCase() + b.status.slice(1)}</span></td>
                                <td>
                                    ${b.status === 'approved' ? `
                                        <button class="btn btn-sm btn-primary" onclick="createInvoice(${b.id})">
                                            <i class="bi bi-file-earmark-plus"></i> Create Invoice
                                        </button>
                                    ` : ''}
                                    ${b.invoice_id ? `
                                        <a href="/api/invoices/${b.invoice_id}/download/" class="btn btn-sm btn-success">
                                            <i class="bi bi-download"></i> Download
                                        </a>
                                    ` : ''}
                                </td>
                                <td>
                                    ${b.invoice_status === 'sent' ? `
                                        <button class="btn btn-sm btn-warning" onclick="processPayment(${b.invoice_id})">
                                            <i class="bi bi-credit-card"></i> Pay Now
                                        </button>
                                    ` : ''}
                                    ${b.invoice_status === 'paid' ? `
                                        <span class="badge bg-success">Paid</span>
                                    ` : ''}
                                </td>
                                <td>
                                    ${b.status === 'pending' ? `
                                        <button class="btn btn-sm btn-danger" onclick="cancelBooking(${b.id})">
                                            <i class="bi bi-x-circle"></i> Cancel
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } catch (e) {
        console.error(e);
        document.getElementById('bookings-container').innerHTML = '<div class="alert alert-danger">Error loading bookings</div>';
    }
}

async function processPayment(invoiceId) {
    try {
        const res = await fetch('/api/payments/process/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                invoice_id: invoiceId
            })
        });
        
        if (!res.ok) {
            const error = await res.json();
            showToast(error.error || 'Failed to process payment', 'error');
            return;
        }
        
        const payment = await res.json();
        
        // Initialize Razorpay checkout
        const options = {
            key: payment.razorpay_key_id,
            amount: payment.amount_paise,
            currency: payment.currency,
            name: 'Room Rental System',
            description: payment.description,
            order_id: payment.razorpay_order_id,
            handler: async function (response) {
                try {
                    console.log('DEBUG: Razorpay response received:', response);
                    
                    const callbackData = {
                        payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_signature: response.razorpay_signature
                    };
                    
                    console.log('DEBUG: Sending callback data:', callbackData);
                    
                    const callbackRes = await fetch('/api/payments/razorpay/callback/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(callbackData)
                    });
                    
                    console.log('DEBUG: Callback response status:', callbackRes.status);
                    
                    if (callbackRes.ok) {
                        showToast('Payment processed successfully!', 'success');
                        // Close Razorpay modal and refresh bookings
                        rzp.close();
                        setTimeout(() => {
                            loadBookings();
                        }, 1000);
                    } else {
                        const error = await callbackRes.json();
                        showToast('Payment verification failed: ' + (error.error || 'Unknown error'), 'error');
                    }
                } catch (e) {
                    console.error(e);
                    showToast('Error verifying payment', 'error');
                }
            },
            modal: {
                ondismiss: function() {
                    console.log('Razorpay modal dismissed');
                },
                escape: true,
                backdropclose: false,
                handleback: true
            },
            prefill: {
                name: payment.customer_name,
                email: payment.customer_email,
            },
            theme: {
                color: '#3399cc'
            }
        };
        
        const rzp = new Razorpay(options);
        rzp.open();
    } catch (e) {
        console.error(e);
        showToast('Error processing payment', 'error');
    }
}

async function createInvoice(bookingId) {
    try {
        const res = await fetch(`/api/invoices/create/${bookingId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (!res.ok) {
            const error = await res.json();
            let errorMessage = error.error || 'Failed to create invoice';
            
            // Provide more specific error messages
            if (error.error && error.error.includes('approved')) {
                errorMessage = 'Invoice can only be created for approved bookings. Please wait for the room owner to approve your booking.';
            } else if (error.error && error.error.includes('already exists')) {
                errorMessage = 'Invoice has already been created for this booking.';
            }
            
            showToast(errorMessage, 'error');
            return;
        }
        
        showToast('Invoice created successfully!', 'success');
        loadBookings();
    } catch (e) {
        console.error(e);
        showToast('Error creating invoice', 'error');
    }
}

async function cancelBooking(bookingId) {
    if (!confirm('Are you sure you want to cancel this booking?')) {
        return;
    }
    
    try {
        const res = await fetch(`/api/bookings/cancel/${bookingId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (!res.ok) {
            const error = await res.json();
            showToast(error.error || 'Failed to cancel booking', 'error');
            return;
        }
        
        showToast('Booking cancelled successfully!', 'success');
        loadBookings();
    } catch (e) {
        console.error(e);
        showToast('Error cancelling booking', 'error');
    }
}

loadBookings();
</script>
{% endblock %}
